{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Administration</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #f5f6fa;
        }
        #map {
            height: 350px;
            border-radius: 10px;
        }
        .card-header {
            font-weight: bold;
        }
    </style>
</head>

<body>

<!-- ‚ñ¨‚ñ¨‚ñ¨ NAVBAR ‚ñ¨‚ñ¨‚ñ¨ -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg,#0f172a,#0ea5a3);">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">SAUTI | Isangi</a>
        <div class="d-flex">
            <a class="btn btn-sm btn-light me-2" href="{% url 'export_menages_csv' %}">‚¨áÔ∏è Export CSV</a>
            <a class="btn btn-sm btn-primary me-2" href="{% url 'gestion_utilisateurs' %}">üßë Utilisateurs</a>
            <a class="btn btn-sm btn-dark me-2" href="{% url 'liste_menages' %}">üì¶ Distibution</a>
            <a class="btn btn-sm btn-danger" href="{% url 'logout' %}">D√©connexion</a>
        </div>
    </div>
</nav>


<div class="container mt-4">

    <!-- ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ FILTRES ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ -->
    <div class="card mb-3">
        <div class="card-header">üîç Filtres de recherche</div>
        <div class="card-body">

            <form method="GET" class="row g-3">

                <!-- Aire de sant√© -->
                <div class="col-md-2">
                    <label class="form-label">Aire de Sant√©</label>
                    <select name="air_sante" class="form-select">
                        <option value="">-- Toutes les Aires --</option>

                        {% for air, label in AIR_SANTE_CHOICES %}
                            <option value="{{ air }}" {% if air_filter == air %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Enqu√™teur -->
                <div class="col-md-2">
                    <label class="form-label">Enqu√™teur</label>
                    <select name="enqueteur" class="form-select">
                        <option value="">-- Tous les enqu√™teurs --</option>

                        {% for user in enqueteurs %}
                            <option value="{{ user.id }}" {% if enqueteur_filter|add:""|safe == user.id|add:""|safe %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Quartier -->
                <div class="col-md-2">
                    <label class="form-label">Quartier</label>
                    <select name="quartier" class="form-select">
                        <option value="">-- Tous les quartiers --</option>

                        {% for q in quartiers %}
                            <option value="{{ q }}" {% if quartier_filter == q %}selected{% endif %}>
                                {{ q }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary mt-4 w-100">Filtrer</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ MAP + GRAPHIQUE ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ -->
    <div class="row">
        
        <!-- MAP -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">üó∫Ô∏è Localisation des m√©nages</div>
                <div class="card-body">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- GRAPHIQUE -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">üìä R√©partition des niveaux de vuln√©rabilit√©</div>
                <div class="card-body">
                    <canvas id="vulnerabiliteChart" height="300"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ LISTE DES MENAGES ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ -->
    <div class="card m-2">
        <div class="card-header">üìã Liste des m√©nages ({{ total_menages }})</div>

        <div class="table-responsive mx-5 my-3">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Identit√©</th>
                        <th>Village</th>
                        <th>Aire de Sant√©</th>
                        <th>Enqu√™teur</th>
                        <th>Score</th>
                        <th>Niveau</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                    {% for m in menages %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ m.identite }}</td>
                        <td>{{ m.village_quartier }}</td>
                        <td>{{ m.air_sante }}</td>
                        <td>{{ m.nom_enqueteur }}</td>
                        <td>{{ m.score_total }}</td>
                        <td>
                        {% if m.voir_vulnerabilite == 'Moins vuln√©rable' %}
                        <span class='badge bg-success' >{{ m.voir_vulnerabilite }}</span>
                        {% elif m.voir_vulnerabilite == 'Vuln√©rable' %}
                        <span class='badge bg-warning' >{{ m.voir_vulnerabilite }}</span>
                        {% else %}
                        <span class='badge bg-danger' >{{ m.voir_vulnerabilite }}</span>
                        {% endif %}
                        </td>

                        <td>
                            <a class="btn btn-sm btn-primary" href="{% url 'details_menage' m.id %}">
                                Voir d√©tails
                            </a>
                            <a class="btn btn-sm btn-outline-success" href="{% url 'fiche_menage' m.id %}">
                                <i class="bi bi-printer-fill"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-danger">Aucun m√©nage trouv√©</td>
                    </tr>
                    {% endfor %}
                    
                </tbody>

            </table>
        </div>
        <div class="card-footer border-0">
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if menages.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ menages.previous_page_number }}{% if air_filter %}&air_sante={{ air_filter }}{% endif %}{% if enqueteur_filter %}&enqueteur={{ enqueteur_filter }}{% endif %}{% if quartier_filter %}&quartier={{ quartier_filter }}{% endif %}">Pr√©c√©dent</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Pr√©c√©dent</span></li>
                    {% endif %}

                    {% for num in menages.paginator.page_range %}
                        {% if menages.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if air_filter %}&air_sante={{ air_filter }}{% endif %}{% if enqueteur_filter %}&enqueteur={{ enqueteur_filter }}{% endif %}{% if quartier_filter %}&quartier={{ quartier_filter }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if menages.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ menages.next_page_number }}{% if air_filter %}&air_sante={{ air_filter }}{% endif %}{% if enqueteur_filter %}&enqueteur={{ enqueteur_filter }}{% endif %}{% if quartier_filter %}&quartier={{ quartier_filter }}{% endif %}">Suivant</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Suivant</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>

</div>

<!-- Leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    const menages = {{ menages_json|safe }};
    const stats = {{ stats_vulnerabilite_json|safe }};

    // Initialisation de la map
    const map = L.map('map').setView([0.518, 25.18], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    // Marqueurs
    menages.forEach(m => {
        L.marker([m.latitude, m.longitude])
            .addTo(map)
            .bindPopup(`
                <b>${m.identite}</b><br>
                Quartier : ${m.village_quartier}<br>
                Aire de sant√© : ${m.air_sante}
            `);
    });


    // ---- GRAPHIQUE VULNERABILIT√â ----
    const ctx = document.getElementById('vulnerabiliteChart').getContext('2d');

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Tr√®s vuln√©rable', 'Vuln√©rable', 'Moins vuln√©rable'],
            datasets: [{
                data: [
                    stats.tres_vulnerable,
                    stats.vulnerable,
                    stats.moins_vulnerable
                ],
                backgroundColor: ['#dc3545', '#fd7e14', '#198754']
            }]
        }
    });
</script>

</body>
</html>
