{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Dashboard Kits WASH</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet (carte) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Small, clean admin styling ‚Äî extract to static/css/admin.css si besoin */
    body { background:#f5f7fb; }
    .card-hero { border-radius: 14px; box-shadow: 0 6px 18px rgba(22,32,93,0.08); }
    .stat-number { font-size: 1.6rem; font-weight:700; }
    .table-wrap { max-height:480px; overflow:auto; }
    #map { height: 360px; border-radius: 10px; }
    .filter-row .form-control { min-width: 160px; }
    .badge-priority { background: #e11d48; color:white; }
    .badge-medium { background: #f59e0b; color:white; }
    .badge-low { background: #10b981; color:white; }
    .btn-export { background: linear-gradient(90deg,#4f46e5,#06b6d4); color:#fff; border: none; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg,#0f172a,#0ea5a3);">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Kits WASH ‚Äî Admin</a>
    <div class="d-flex">
      <a class="btn btn-sm btn-light me-2" href="{% url 'export_menages_csv' %}">‚¨áÔ∏è Export CSV</a>
      <a class="btn btn-sm btn-danger" href="{% url 'logout' %}">D√©connexion</a>
    </div>
  </div>
</nav>

<div class="container my-4">
  <!-- Top cards -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card p-3 card-hero">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">M√©nages total</div>
            <div class="stat-number">{{ stats.total }}</div>
          </div>
          <div class="text-end">
            <small class="text-muted">Enqu√™tes</small><br>
            <span class="fw-semibold">{{ stats.total_enquetes }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 card-hero">
        <div>
          <div class="text-muted">Tr√®s vuln√©rables</div>
          <div class="stat-number text-danger">{{ stats.very_vuln }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 card-hero">
        <div>
          <div class="text-muted">Vuln√©rables</div>
          <div class="stat-number text-warning">{{ stats.vuln }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 card-hero">
        <div>
          <div class="text-muted">Moins vuln√©rables</div>
          <div class="stat-number text-success">{{ stats.low }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters + chart + map -->
  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">R√©partition des niveaux</h5>
          <div class="d-flex gap-2 filter-row">
            <form method="get" class="d-flex gap-2">
              <select name="quartier" class="form-select form-select-sm">
                <option value="">Tous quartiers</option>
                {% for q in quartiers %}
                <option value="{{ q }}" {% if request.GET.quartier == q %}selected{% endif %}>{{ q }}</option>
                {% endfor %}
              </select>

              <select name="enqueteur" class="form-select form-select-sm">
                <option value="">Tous enqu√™teurs</option>
                {% for e in enqueteurs %}
                <option value="{{ e }}" {% if request.GET.enqueteur == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
              </select>

              <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
            </form>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <canvas id="vulnChart" height="220"></canvas>
          </div>
          <div class="col-md-6">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: recent m√©nages -->
    <div class="col-lg-4">
      <div class="card p-3">
        <h6>Top m√©nages prioritaires</h6>
        <div class="list-group mt-2">
          {% for m in top_priority %}
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ m.identite|default:"(non renseign√©)" }}</div>
              <small class="text-muted">{{ m.village_quartier }} ‚Ä¢ {{ m.numero_menage }}</small>
            </div>
            <div class="text-end">
              <span class="badge badge-priority rounded-pill">{{ m.score_total }}</span>
              <div><small class="text-muted">{{ m.date_enquete }}</small></div>
            </div>
          </div>
          {% empty %}
          <div class="text-muted small p-2">Aucun m√©nage prioritaire pour l'instant</div>
          {% endfor %}
        </div>
      </div>

      <div class="card p-3 mt-3">
        <h6>Actions rapides</h6>
        <div class="d-grid gap-2 mt-2">
          <a href="{% url 'export_menages_csv' %}" class="btn btn-export">‚¨áÔ∏è Exporter tous (CSV)</a>
          <a href="#" class="btn btn-outline-secondary">üñ®Ô∏è Imprimer la liste</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Table listing -->
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Liste des m√©nages</h5>
      <small class="text-muted">Total: {{ stats.total }}</small>
    </div>
    <div class="table-wrap">
      <table class="table table-hover table-sm">
        <thead class="table-light sticky-top">
          <tr>
            <th>#</th>
            <th>Identit√©</th>
            <th>Quartier</th>
            <th>N¬∞ m√©nage</th>
            <th>Score</th>
            <th>Niveau</th>
            <th>Enqu√™teur</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for m in menages %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ m.identite|default:"-" }}</td>
            <td>{{ m.village_quartier|default:"-" }}</td>
            <td>{{ m.numero_menage }}</td>
            <td><strong>{{ m.score_total }}</strong></td>
            <td>
              {% if m.score_total >= 75 %}
                <span class="badge badge-priority">Tr√®s vuln√©rable</span>
              {% elif m.score_total >= 45 %}
                <span class="badge badge-medium">Vuln√©rable</span>
              {% else %}
                <span class="badge badge-low">Moins vuln√©rable</span>
              {% endif %}
            </td>
            <td>{{ m.nom_enqueteur }}</td>
            <td>{{ m.date_enquete }}</td>
            <td>
                <a href="{% url 'details_menage' m.id %}" class="btn btn-sm btn-outline-primary">D√©tails</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-muted">Aucun m√©nage enregistr√©</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination si tu veux -->
    <div class="d-flex justify-content-end mt-2">
      {% if is_paginated %}
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">‚Äπ</a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">‚Ä∫</a></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Chart data from context variables (serialized by view)
  const chartData = {
    labels: ['Tr√®s vuln√©rable','Vuln√©rable','Moins vuln√©rable'],
    counts: [{{ stats.very_vuln }}, {{ stats.vuln }}, {{ stats.low }}]
  };

  const ctx = document.getElementById('vulnChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: chartData.labels,
      datasets: [{
        data: chartData.counts,
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' }
      },
      maintainAspectRatio: false
    }
  });

  // Map with Leaflet - add markers passed from Django context
  const menagesGeo = {{ menages_geo|safe }}; // array of {lat, lon, popup}
  const map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(map);

  if (menagesGeo.length) {
    const bounds = [];
    menagesGeo.forEach(m => {
      if (m.lat && m.lon) {
        const marker = L.circleMarker([m.lat, m.lon], {radius:7}).addTo(map);
        marker.bindPopup(m.popup);
        bounds.push([m.lat, m.lon]);
      }
    });
    if (bounds.length) map.fitBounds(bounds, {padding:[40,40]});
  } else {
    map.setView([ -1.2921, 36.8219 ], 6); // fallback: Kinshasa region adjust
  }
</script>
</body>
</html>
